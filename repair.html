<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>บันทึกการซ่อมอุปกรณ์</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
    background-color: #f2f2f2;
  }
  .form-container {
    max-width: 600px;
    margin: auto;
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  }
  h2 {
    text-align: center;
    color: #333;
  }
  label {
    display: block;
    margin-top: 15px;
    font-weight: bold;
  }
  input, select, textarea {
    width: 100%;
    padding: 8px;
    margin-top: 5px;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-sizing: border-box;
  }
  .btn {
    background-color: #4CAF50;
    color: white;
    padding: 10px 15px;
    margin-top: 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    width: 100%;
    font-size: 16px;
  }
  .btn:hover {
    background-color: #45a049;
  }
  .equipment-preview {
    margin-top: 20px;
    background: #f9f9f9;
    padding: 10px;
    border-radius: 4px;
  }
  .equipment-preview img {
    max-width: 100%;
    max-height: 200px;
    margin-top: 10px;
    border: 1px solid #ccc;
  }
  .back-link {
    display: block;
    text-align: center;
    margin-bottom: 10px;
    text-decoration: none;
    color: #007bff;
  }
  .back-link:hover {
    text-decoration: underline;
  }
</style>
</head>
<body>

<div class="form-container">
  <a href="index.html" class="back-link">← กลับหน้าแดชบอร์ด</a>
  <h2>บันทึกการซ่อมอุปกรณ์</h2>

  <label>เลือกชื่ออุปกรณ์:</label>
  <select id="nameSelect" onchange="loadEquipmentData()">
    <option value="">-- เลือกชื่ออุปกรณ์ --</option>
  </select>

  <div class="equipment-preview" id="equipmentPreview" style="display: none;">
    <p><strong>Ref:</strong> <span id="refDisplay"></span></p>
    <p><strong>ประเภท:</strong> <span id="typeDisplay"></span></p>
    <p><strong>ยี่ห้อ:</strong> <span id="brandDisplay"></span></p>
    <p><strong>รุ่น:</strong> <span id="modelDisplay"></span></p>
    <div id="imageContainer"></div>
  </div>

  <label>วันที่ซ่อม:</label>
  <input type="text" id="repairDate" placeholder="ระบุวันที่ เช่น 01/07/2567">
  <small style="color:#666;">กรุณากรอกเป็นรูปแบบ วันที่/เดือน/ปี พ.ศ.</small>

  <label>รายละเอียดการซ่อม:</label>
  <textarea id="repairDetail" rows="4"></textarea>

  <label>ค่าใช้จ่าย (บาท):</label>
  <input type="number" id="repairCost">

  <button class="btn" onclick="saveRepair()">บันทึกการซ่อม</button>
</div>

<script>
// ❗ ใส่ URL Web App ของ Apps Script ตรงนี้
const API_URL = 'https://script.google.com/macros/s/WEB_APP_ID/exec';

let equipmentList = [];

/**
 * โหลดรายการอุปกรณ์ทั้งหมดจาก API
 */
async function loadEquipmentList() {
  const select = document.getElementById("nameSelect");
  select.innerHTML = `<option value="">กำลังโหลด...</option>`;

  try {
    const res = await fetch(`${API_URL}?action=getAllEquipment`);
    if (!res.ok) throw new Error('HTTP ' + res.status);
    equipmentList = await res.json(); // เป็น Array ของ Object

    select.innerHTML = `<option value="">-- เลือกชื่ออุปกรณ์ --</option>`;
    equipmentList.forEach(item => {
      const option = document.createElement("option");
      option.value = item["Ref"];
      option.text = item["ชื่อ"] || item["ชื่อทั่วไป"] || item["Ref"];
      select.appendChild(option);
    });

  } catch (err) {
    console.error(err);
    select.innerHTML = `<option value="">โหลดข้อมูลไม่สำเร็จ</option>`;
    Swal.fire("เกิดข้อผิดพลาด", err.message || "ไม่สามารถโหลดรายการอุปกรณ์ได้", "error");
  }
}

/**
 * เมื่อเลือกอุปกรณ์ → โหลดรายละเอียดจาก API
 */
async function loadEquipmentData() {
  const ref = document.getElementById("nameSelect").value;
  const previewBox = document.getElementById("equipmentPreview");

  if (!ref) {
    previewBox.style.display = "none";
    return;
  }

  try {
    const res = await fetch(`${API_URL}?action=getEquipmentByRef&ref=${encodeURIComponent(ref)}`);
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const item = await res.json();

    if (!item || !item["Ref"]) {
      Swal.fire("ผิดพลาด", "ไม่พบข้อมูลอุปกรณ์", "error");
      previewBox.style.display = "none";
      return;
    }

    document.getElementById("refDisplay").innerText = item["Ref"];
    document.getElementById("typeDisplay").innerText = item["ประเภท"] || "";
    document.getElementById("brandDisplay").innerText = item["ยี่ห้อ"] || "";
    document.getElementById("modelDisplay").innerText = item["รุ่น"] || "";

    const imgUrl = item["รูปภาพ"] || "";
    const imgContainer = document.getElementById("imageContainer");
    imgContainer.innerHTML = imgUrl ? `<img src="${imgUrl}">` : "<p>ไม่มีรูปภาพ</p>";

    previewBox.style.display = "block";

  } catch (err) {
    console.error(err);
    previewBox.style.display = "none";
    Swal.fire("เกิดข้อผิดพลาด", err.message || "ไม่สามารถโหลดข้อมูลอุปกรณ์ได้", "error");
  }
}

/**
 * บันทึกข้อมูลการซ่อมไปที่ API (saveRepairData)
 */
async function saveRepair() {
  const ref = document.getElementById("refDisplay").innerText.trim();
  const repairDate = document.getElementById("repairDate").value.trim();
  const repairDetail = document.getElementById("repairDetail").value.trim();
  const repairCost = document.getElementById("repairCost").value.trim();

  if (!ref) {
    Swal.fire("กรุณาเลือกอุปกรณ์ก่อนบันทึก", "", "warning");
    return;
  }
  if (!repairDate || !repairDetail) {
    Swal.fire("กรุณากรอกข้อมูลวันที่ซ่อม และรายละเอียดให้ครบถ้วน", "", "warning");
    return;
  }

  const repairData = {
    ref,
    repairDate,
    repairDetail,
    repairCost
  };

  Swal.fire({
    title: 'กำลังบันทึก...',
    allowOutsideClick: false,
    didOpen: () => Swal.showLoading()
  });

  try {
    const res = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'saveRepairData',
        data: repairData
      })
    });

    const result = await res.json();
    Swal.close();

    if (!res.ok || result.success === false) {
      throw new Error(result.error || 'บันทึกข้อมูลไม่สำเร็จ');
    }

    Swal.fire("สำเร็จ", result.message || "บันทึกข้อมูลการซ่อมเรียบร้อย", "success");
    document.getElementById("repairDate").value = "";
    document.getElementById("repairDetail").value = "";
    document.getElementById("repairCost").value = "";

  } catch (err) {
    console.error(err);
    Swal.close();
    Swal.fire("เกิดข้อผิดพลาด", err.message || "ไม่สามารถบันทึกข้อมูลได้", "error");
  }
}

window.onload = loadEquipmentList;
</script>

</body>
</html>
