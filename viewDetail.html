<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
  body {
    font-family: "Segoe UI", Arial, sans-serif;
    margin: 20px;
    background: linear-gradient(135deg, #e8f0ff, #ffffff);
  }

  h2 {
    text-align: center;
    color: #333;
    margin-bottom: 20px;
    text-shadow: 1px 1px 3px rgba(0,0,0,0.2);
  }

  .section {
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    padding: 20px;
    margin-bottom: 25px;
    width: 100%;
    max-width: 800px;
  }

  .section h3 {
    text-align: center;
    margin-bottom: 15px;
    color: #004085;
    border-bottom: 2px solid #ddd;
    padding-bottom: 5px;
  }

  .container {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    justify-content: center;
  }

  .detail-table {
    width: 100%;
    border-collapse: collapse;
    background: #fff;
    box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
    border-radius: 6px;
    overflow: hidden;
  }

  .detail-table th, .detail-table td {
    padding: 12px 15px;
    border: 1px solid #ddd;
    text-align: left;
    vertical-align: top;
  }

  .detail-table th {
    background: #f1f1f1;
    color: #555;
    width: 35%;
  }

  .detail-table td {
    background: #fff;
  }

  .image-container {
    text-align: center;
    margin-top: 20px;
  }

  .image-container img {
    max-width: 100%;
    max-height: 400px;
    border: 2px solid #ccc;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    object-fit: contain;
  }

  .btn {
    display: inline-block;
    margin: 10px 5px;
    padding: 10px 20px;
    background: linear-gradient(135deg, #4CAF50, #3e8e41);
    color: #fff;
    border: none;
    border-radius: 25px;
    cursor: pointer;
    font-size: 14px;
    box-shadow: 0 3px 8px rgba(0,0,0,0.3);
    transition: all 0.3s ease;
  }

  .btn:hover {
    background: linear-gradient(135deg, #3e8e41, #2f6b31);
    transform: scale(1.05);
  }

  .btn-close {
    background: linear-gradient(135deg, #dc3545, #c82333);
  }

  .btn-close:hover {
    background: linear-gradient(135deg, #c82333, #a71d2a);
  }

  #pdfContainer a {
    display: inline-block;
    margin: 5px;
    padding: 6px 12px;
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
    text-decoration: none;
    border-radius: 20px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    transition: all 0.3s ease;
  }

  #pdfContainer a:hover {
    background: linear-gradient(135deg, #0056b3, #003d80);
    transform: translateY(-2px);
  }

  .repair-table {
    width: 100%;
    border-collapse: collapse;
    box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
    border-radius: 6px;
    overflow: hidden;
  }

  .repair-table th, .repair-table td {
    padding: 10px 15px;
    border: 1px solid #ddd;
    text-align: center;
  }

  .repair-table th {
    background: #f1f1f1;
  }

  .status-label {
    display: inline-block;
    padding: 6px 12px;
    border-radius: 20px;
    color: white;
    font-weight: bold;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    min-width: 80px;
    text-align: center;
  }

  .status-normal {
    background: linear-gradient(135deg, #28a745, #218838);
  }

  .status-broken {
    background: linear-gradient(135deg, #dc3545, #c82333);
  }

  .status-repair {
    background: linear-gradient(135deg, #ffc107, #e0a800);
    color: black;
  }

  #editModal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }

  #editModalContent {
    background: #fff;
    padding: 20px;
    border-radius: 8px;
    max-width: 700px;
    width: 90%;
    max-height: 90%;
    overflow: auto;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
  }

  .modal-column {
    flex: 1 1 45%;
  }

  .modal-column label {
    display: block;
    margin-bottom: 10px;
  }

  .modal-footer {
    width: 100%;
    text-align: center;
    margin-top: 15px;
  }
</style>
</head>
<body>

<h2>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h2>

<div style="text-align: center; margin-bottom: 10px;">
  <button class="btn" onclick="openEdit()">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
  <button class="btn btn-close" onclick="goBack()">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</button>
</div>

<div class="container">

  <div class="section">
    <h3>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</h3>
    <table class="detail-table">
      <tr><th>ID</th><td id="id"></td></tr>
      <tr><th>Ref</th><td id="ref"></td></tr>
      <tr><th>‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</th><td id="commonName"></td></tr>
      <tr><th>‡∏ä‡∏∑‡πà‡∏≠</th><td id="name"></td></tr>
      <tr><th>‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©/‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤</th><td id="engName"></td></tr>
      <tr><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><td id="type"></td></tr>
      <tr><th>‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠</th><td id="brand"></td></tr>
      <tr><th>‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ú‡∏π‡πâ‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢</th><td id="supplier"></td></tr>
      <tr><th>‡∏£‡∏∏‡πà‡∏ô</th><td id="model"></td></tr>
      <tr><th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏</th><td id="packageNo"></td></tr>
      <tr><th>S/N</th><td id="sn"></td></tr>
      <tr><th>‡∏£‡∏≤‡∏Ñ‡∏≤(‡∏ö‡∏≤‡∏ó)</th><td id="price"></td></tr>
      <tr><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><td id="amount"></td></tr>
      <tr><th>‡∏á‡∏ö‡∏õ‡∏µ</th><td id="budgetYear"></td></tr>
      <tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö</th><td id="receivedDate"></td></tr>
      <tr><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö</th><td id="location"></td></tr>
      <tr><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><td id="status"></td></tr>
      <tr><th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th><td id="remark"></td></tr>
    </table>
  </div>

  <div class="section image-container">
    <h3>‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</h3>
    <div id="imageContainer">
      <img id="previewImage" src="" alt="‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û">
    </div>
  </div>

  <div class="section">
    <h3>‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö (PDF)</h3>
    <div id="pdfContainer">
      <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£...</p>
    </div>
    <div style="text-align: center; margin-top: 15px;">
      <label class="btn">
        ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå PDF ‡πÉ‡∏´‡∏°‡πà
        <input type="file" id="pdfFile" accept="application/pdf" style="display:none" onchange="uploadPDF()" disabled>
      </label>
    </div>
  </div>

  <div class="section">
    <h3>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á</h3>
    <table class="repair-table" id="repairTable">
      <thead>
        <tr>
          <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</th>
          <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏°</th>
          <th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°</th>
          <th>‡∏£‡∏≤‡∏Ñ‡∏≤(‡∏ö‡∏≤‡∏ó)</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°</td></tr>
      </tbody>
    </table>
  </div>

</div>

<!-- Modal ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç -->
<div id="editModal">
  <div id="editModalContent">

    <div class="modal-column">
      <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ:
        <input type="text" id="editCommonName">
      </label>
      <label>‡∏ä‡∏∑‡πà‡∏≠:
        <input type="text" id="editName">
      </label>
      <label>‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©/‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤:
        <input type="text" id="editEngName">
      </label>
      <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:
        <input type="text" id="editType">
      </label>
      <label>‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠:
        <input type="text" id="editBrand">
      </label>
      <label>‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ú‡∏π‡πâ‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢:
        <input type="text" id="editSupplier">
      </label>
      <label>‡∏£‡∏∏‡πà‡∏ô:
        <input type="text" id="editModel">
      </label>
      <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏:
        <input type="text" id="editPackageNo">
      </label>
    </div>

    <div class="modal-column">
      <label>S/N:
        <input type="text" id="editSn">
      </label>
      <label>‡∏£‡∏≤‡∏Ñ‡∏≤(‡∏ö‡∏≤‡∏ó):
        <input type="number" id="editPrice">
      </label>
      <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:
        <input type="number" id="editAmount">
      </label>
      <label>‡∏á‡∏ö‡∏õ‡∏µ:
        <input type="text" id="editBudgetYear">
      </label>
      <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö:
        <input type="text" id="editReceivedDate" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡πÄ‡∏ä‡πà‡∏ô 30/06/2567">
      </label>
      <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö:
        <input type="text" id="editLocation">
      </label>
      <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:
        <select id="editStatus">
          <option value="‡∏õ‡∏Å‡∏ï‡∏¥">‡∏õ‡∏Å‡∏ï‡∏¥</option>
          <option value="‡∏ä‡∏≥‡∏£‡∏∏‡∏î">‡∏ä‡∏≥‡∏£‡∏∏‡∏î</option>
          <option value="‡∏™‡πà‡∏á‡∏ã‡πà‡∏≠‡∏°">‡∏™‡πà‡∏á‡∏ã‡πà‡∏≠‡∏°</option>
        </select>
      </label>
      <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:
        <input type="text" id="editRemark">
      </label>
    </div>

    <div class="modal-column" style="flex: 1 1 100%; text-align: center;">
      <p style="margin-bottom: 10px; font-weight: bold;">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:</p>
      <img id="editPreviewImage" src="" alt="‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏î‡∏¥‡∏°"
           style="max-width: 300px; max-height: 200px; margin-bottom: 15px;
                  border: 2px solid #ccc; border-radius: 8px;
                  box-shadow: 0 2px 6px rgba(0,0,0,0.2);">

      <label style="display:block; margin-top: 15px;">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏´‡∏°‡πà:
        <input type="file" id="editImageFile" accept="image/*" onchange="previewNewImage()" style="margin-top: 5px;">
      </label>
    </div>

    <div class="modal-footer">
      <button class="btn" onclick="saveEdit()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      <button class="btn btn-close" onclick="closeEdit()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>

  </div>
</div>

<script>
// üîó ‡πÉ‡∏™‡πà URL Web App ‡∏Ç‡∏≠‡∏á Apps Script ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
const API_URL = 'https://script.google.com/macros/s/AKfycbzU70jZI0LU_wTmOlAx_0H7o6_SNq122_YXxCe5Mz3YylxlOx07I3BlNYLF78IGEc1m/exec';

let ref = null;

window.addEventListener('DOMContentLoaded', () => {
  const params = new URLSearchParams(window.location.search);
  ref = params.get('ref');

  if (!ref) {
    Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏û‡∏ö Ref ‡πÉ‡∏ô URL', 'error');
    return;
  }

  console.log("‚úÖ Ref ‡∏à‡∏≤‡∏Å URL:", ref);
  document.getElementById("pdfFile").disabled = false;
  loadAllData();
});

// ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ï‡∏≤‡∏° ref
async function loadAllData() {
  try {
    // ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
    console.log("‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå...");
    const resDetail = await fetch(`${API_URL}?action=getEquipmentByRef&ref=${encodeURIComponent(ref)}`);
    const item = await resDetail.json();
    console.log("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:", item);
    showDetail(item);

    // ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ã‡πà‡∏≠‡∏°
    console.log("‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°...");
    const resRepair = await fetch(`${API_URL}?action=getRepairHistoryByRef&ref=${encodeURIComponent(ref)}`);
    const repairData = await resRepair.json();
    console.log("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πà‡∏≠‡∏°:", repairData);
    showRepairHistory(repairData);

    // PDF
    console.log("‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ PDF...");
    const resPdf = await fetch(`${API_URL}?action=getPDFLinksByRef&ref=${encodeURIComponent(ref)}`);
    const pdfList = await resPdf.json();
    showPDFList(pdfList);

  } catch (err) {
    console.error(err);
    Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', err.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
  }
}

function showDetail(item) {
  if (!item) {
    Swal.fire('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Ref ‡∏ô‡∏µ‡πâ', 'warning');
    return;
  }

  document.getElementById("id").innerText = item["ID"] || "";
  document.getElementById("ref").innerText = item["Ref"] || "";
  document.getElementById("commonName").innerText = item["‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ"] || "";
  document.getElementById("name").innerText = item["‡∏ä‡∏∑‡πà‡∏≠"] || "";
  document.getElementById("engName").innerText = item["‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©/‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤"] || "";
  document.getElementById("type").innerText = item["‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó"] || "";
  document.getElementById("brand").innerText = item["‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠"] || "";
  document.getElementById("supplier").innerText = item["‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ú‡∏π‡πâ‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢"] || "";
  document.getElementById("model").innerText = item["‡∏£‡∏∏‡πà‡∏ô"] || "";
  document.getElementById("packageNo").innerText = item["‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏"] || "";
  document.getElementById("sn").innerText = item["S/N"] || "";
  document.getElementById("price").innerText = item["‡∏£‡∏≤‡∏Ñ‡∏≤(‡∏ö‡∏≤‡∏ó)"] || "";
  document.getElementById("amount").innerText = item["‡∏à‡∏≥‡∏ô‡∏ß‡∏ô"] || "";
  document.getElementById("budgetYear").innerText = item["‡∏á‡∏ö‡∏õ‡∏µ"] || "";
  document.getElementById("receivedDate").innerText = toThaiDateString(item["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö"]);
  document.getElementById("location").innerText = item["‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö"] || "";

  const statusText = item["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞"] || "";
  const statusElement = document.getElementById("status");

  let statusClass = "";
  if (statusText === "‡∏õ‡∏Å‡∏ï‡∏¥") statusClass = "status-label status-normal";
  else if (statusText === "‡∏ä‡∏≥‡∏£‡∏∏‡∏î") statusClass = "status-label status-broken";
  else if (statusText === "‡∏™‡πà‡∏á‡∏ã‡πà‡∏≠‡∏°") statusClass = "status-label status-repair";

  statusElement.innerHTML = `<span class="${statusClass}">${statusText}</span>`;
  document.getElementById("remark").innerText = item["‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏"] || "";

  const imageUrl = item["‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û"] || "";
  if (imageUrl) {
    document.getElementById("previewImage").src = imageUrl;
  } else {
    document.getElementById("imageContainer").innerHTML = `<p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</p>`;
  }
}

function toThaiDateString(dateStr) {
  if (!dateStr) return "";
  const parts = dateStr.split("/");
  if (parts.length !== 3) return dateStr;

  const day = parts[0];
  const month = parts[1];
  let year = parseInt(parts[2]);

  if (year < 2500) year += 543;
  return `${day}/${month}/${year}`;
}

function showRepairHistory(data) {
  const table = document.getElementById("repairTable").getElementsByTagName("tbody")[0];
  table.innerHTML = "";

  if (!data || data.length === 0) {
    table.innerHTML = `<tr><td colspan="4" style="text-align: center;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°</td></tr>`;
    return;
  }

  data.forEach(item => {
    const row = `
      <tr>
        <td>${item["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å"] || ""}</td>
        <td>${item["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏°"] || ""}</td>
        <td>${item["‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°"] || ""}</td>
        <td>${item["‡∏£‡∏≤‡∏Ñ‡∏≤(‡∏ö‡∏≤‡∏ó)"] || ""}</td>
      </tr>`;
    table.insertAdjacentHTML("beforeend", row);
  });
}

// ‡πÄ‡∏õ‡∏¥‡∏î Modal ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
function openEdit() {
  if (!ref) {
    Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏û‡∏ö Ref ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', 'error');
    return;
  }
  const modal = document.getElementById("editModal");
  modal.style.display = "flex";
  modal.style.alignItems = "center";
  modal.style.justifyContent = "center";

  document.getElementById("editCommonName").value = document.getElementById("commonName").innerText.trim();
  document.getElementById("editName").value = document.getElementById("name").innerText;
  document.getElementById("editEngName").value = document.getElementById("engName").innerText;
  document.getElementById("editType").value = document.getElementById("type").innerText;
  document.getElementById("editBrand").value = document.getElementById("brand").innerText;
  document.getElementById("editSupplier").value = document.getElementById("supplier").innerText;
  document.getElementById("editModel").value = document.getElementById("model").innerText;
  document.getElementById("editPackageNo").value = document.getElementById("packageNo").innerText;
  document.getElementById("editSn").value = document.getElementById("sn").innerText;
  document.getElementById("editPrice").value = document.getElementById("price").innerText;
  document.getElementById("editAmount").value = document.getElementById("amount").innerText;
  document.getElementById("editBudgetYear").value = document.getElementById("budgetYear").innerText;
  document.getElementById("editReceivedDate").value = document.getElementById("receivedDate").innerText.trim();
  document.getElementById("editLocation").value = document.getElementById("location").innerText;

  const statusElement = document.getElementById("status").querySelector("span");
  document.getElementById("editStatus").value = statusElement ? statusElement.textContent.trim() : "";

  document.getElementById("editRemark").value = document.getElementById("remark").innerText;
  document.getElementById("editPreviewImage").src = document.getElementById("previewImage").src;
}

function closeEdit() {
  document.getElementById("editModal").style.display = "none";
}

function goBack() {
  window.location.href = 'index.html';
}

// preview ‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô modal
function previewNewImage() {
  const file = document.getElementById("editImageFile").files[0];
  const preview = document.getElementById("editPreviewImage");
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      preview.src = e.target.result;
    };
    reader.readAsDataURL(file);
  }
}

// ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (‡∏™‡πà‡∏á‡πÑ‡∏õ updateEquipmentDataWithImage)
async function saveEdit() {
  const refValue = document.getElementById("ref").innerText.trim();
  if (!refValue) {
    Swal.fire("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™ Ref ‡∏Ç‡∏≠‡∏á‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå", "error");
    return;
  }

  const updatedData = {
    ref: refValue,
    ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ: document.getElementById("editCommonName").value,
    ‡∏ä‡∏∑‡πà‡∏≠: document.getElementById("editName").value,
    ‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©: document.getElementById("editEngName").value,
    ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: document.getElementById("editType").value,
    ‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠: document.getElementById("editBrand").value,
    ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ú‡∏π‡πâ‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢: document.getElementById("editSupplier").value,
    ‡∏£‡∏∏‡πà‡∏ô: document.getElementById("editModel").value,
    ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏: document.getElementById("editPackageNo").value,
    SN: document.getElementById("editSn").value,
    ‡∏£‡∏≤‡∏Ñ‡∏≤: document.getElementById("editPrice").value,
    ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: document.getElementById("editAmount").value,
    ‡∏á‡∏ö‡∏õ‡∏µ: document.getElementById("editBudgetYear").value,
    ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö: document.getElementById("editReceivedDate").value,
    ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö: document.getElementById("editLocation").value,
    ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: document.getElementById("editStatus").value,
    ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: document.getElementById("editRemark").value
  };

  const file = document.getElementById("editImageFile").files[0];

  Swal.fire({
    title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...',
    allowOutsideClick: false,
    didOpen: () => Swal.showLoading()
  });

  try {
    let imageBase64 = "";
    if (file) {
      imageBase64 = await fileToBase64(file);
    }

    const res = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'updateEquipmentDataWithImage',
        item: updatedData,
        imageBase64: imageBase64
      })
    });

    const result = await res.json();
    Swal.close();

    if (!res.ok || result.success === false) {
      throw new Error(result.error || '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    }

    Swal.fire({
      icon: 'success',
      title: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢',
      confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
    }).then(() => {
      closeEdit();
      loadAllData();
    });

  } catch (err) {
    console.error(err);
    Swal.close();
    Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', err.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
  }
}

// helper: ‡πÅ‡∏õ‡∏•‡∏á file ‚Üí base64
function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = e => resolve(e.target.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

function showPDFList(pdfList) {
  const container = document.getElementById("pdfContainer");
  container.innerHTML = "";

  if (!pdfList || pdfList.length === 0) {
    container.innerHTML = "<p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö</p>";
    return;
  }

  pdfList.forEach((pdfUrl, index) => {
    const link = document.createElement("a");
    link.href = pdfUrl;
    link.target = "_blank";
    link.innerText = `‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà ${index + 1}`;
    link.style.display = "block";
    link.style.margin = "5px 0";
    container.appendChild(link);
  });
}

// ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î PDF ‡πÉ‡∏´‡∏°‡πà (POST ‚Üí uploadPDF)
function uploadPDF() {
  const file = document.getElementById("pdfFile").files[0];
  if (!file) return;

  if (!ref) {
    Swal.fire("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™ Ref ‡∏Ç‡∏≠‡∏á‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà", "error");
    return;
  }

  if (file.type !== "application/pdf") {
    Swal.fire("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå PDF ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô", "", "warning");
    return;
  }

  Swal.fire({
    title: "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î",
    text: "‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? (‡∏´‡∏≤‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ isAddNew=false ‡πÉ‡∏ô backend ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°)",
    icon: "question",
    showCancelButton: true,
    confirmButtonText: "‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î",
    cancelButtonText: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å"
  }).then(async result => {
    if (!result.isConfirmed) return;

    try {
      const base64PDF = await fileToBase64(file);

      Swal.fire({
        title: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...",
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading()
      });

      const res = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: 'uploadPDF',
          ref: ref,
          base64Data: base64PDF,
          isAddNew: true   // ‡∏´‡∏£‡∏∑‡∏≠ false ‡∏ñ‡πâ‡∏≤‡∏à‡∏∞‡∏•‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô (‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡∏±‡∏ö backend)
        })
      });

      const resultJson = await res.json();
      Swal.close();

      if (!res.ok || resultJson.success === false) {
        throw new Error(resultJson.error || '‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      }

      Swal.fire({
        icon: "success",
        title: "‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢",
        confirmButtonText: "‡∏ï‡∏Å‡∏•‡∏á"
      }).then(() => {
        loadAllData(); // refresh PDF list ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      });

    } catch (err) {
      console.error(err);
      Swal.close();
      Swal.fire("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", err.message || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ", "error");
    }
  });
}
</script>

</body>
</html>
