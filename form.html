<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body {
      font-family: 'Tahoma', sans-serif;
      background: linear-gradient(135deg, #e8f0ff, #ffffff);
    }
    .header {
      background: linear-gradient(135deg, #004085, #0056b3);
      color: white;
      padding: 15px 20px;
      display: flex;
      align-items: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      margin-bottom: 20px;
    }
    .header img {
      height: 50px;
      margin-right: 15px;
    }
    .header h1 {
      font-size: 1.4rem;
      margin: 0;
    }
    .form-container {
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      padding: 20px;
      margin-top: 10px;
    }
    #imagePreview img {
      max-width: 120px;
      max-height: 120px;
      object-fit: cover;
    }
  </style>
</head>
<body>

<div class="header">
  <img src="https://img5.pic.in.th/file/secure-sv1/-52b56ad2d51896660.png">
  <h1>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå - ‡∏´‡πâ‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î‡∏≠‡∏≠‡∏£‡πå‡πÇ‡∏ò‡∏õ‡∏¥‡∏î‡∏¥‡∏Å‡∏™‡πå</h1>
</div>

<div class="container form-container">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0 text-center">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h3>
    <a href="index.html" class="btn btn-secondary btn-sm">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</a>
  </div>

  <form id="equipmentForm">
    <div class="row">
      <div class="col-md-6 mb-3">
        <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</label>
        <input type="text" class="form-control" id="commonName">
      </div>
      <div class="col-md-6 mb-3">
        <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠</label>
        <input type="text" class="form-control" id="name">
      </div>
      <div class="col-md-6 mb-3">
        <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©/‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤</label>
        <input type="text" class="form-control" id="engName">
      </div>
      <div class="col-md-6 mb-3">
        <label class="form-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
        <input type="text" class="form-control" id="type">
      </div>
      <div class="col-md-6 mb-3">
        <label class="form-label">‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠</label>
        <input type="text" class="form-control" id="brand">
      </div>
      <div class="col-md-6 mb-3">
        <label class="form-label">‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ú‡∏π‡πâ‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢</label>
        <input type="text" class="form-control" id="supplier">
      </div>
      <div class="col-md-6 mb-3">
        <label class="form-label">‡∏£‡∏∏‡πà‡∏ô</label>
        <input type="text" class="form-control" id="model">
      </div>
      <div class="col-md-6 mb-3">
        <label class="form-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏</label>
        <input type="text" class="form-control" id="assetNo">
      </div>
      <div class="col-md-6 mb-3">
        <label class="form-label">S/N</label>
        <input type="text" class="form-control" id="serial">
      </div>
      <div class="col-md-4 mb-3">
        <label class="form-label">‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó)</label>
        <input type="number" class="form-control" id="price">
      </div>
      <div class="col-md-4 mb-3">
        <label class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
        <input type="number" class="form-control" id="quantity">
      </div>
      <div class="col-md-4 mb-3">
        <label class="form-label">‡∏á‡∏ö‡∏õ‡∏µ</label>
        <input type="text" class="form-control" id="budgetYear">
      </div>
      <div class="col-md-6 mb-3">
        <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö</label>
        <input type="text" class="form-control" id="receivedDate" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡πÄ‡∏ä‡πà‡∏ô 01/07/2567">
      </div>
      <div class="col-md-6 mb-3">
        <label class="form-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö</label>
        <input type="text" class="form-control" id="location">
      </div>
      <div class="col-md-6 mb-3">
        <label class="form-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
        <select class="form-select" id="status">
          <option value="‡∏õ‡∏Å‡∏ï‡∏¥">‡∏õ‡∏Å‡∏ï‡∏¥</option>
          <option value="‡∏ä‡∏≥‡∏£‡∏∏‡∏î">‡∏ä‡∏≥‡∏£‡∏∏‡∏î</option>
          <option value="‡∏™‡πà‡∏á‡∏ã‡πà‡∏≠‡∏°">‡∏™‡πà‡∏á‡∏ã‡πà‡∏≠‡∏°</option>
        </select>
      </div>
      <div class="col-md-6 mb-3">
        <label class="form-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
        <textarea class="form-control" id="note"></textarea>
      </div>
      <div class="mb-3">
        <label class="form-label">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</label>
        <input type="file" class="form-control" id="imageUpload" accept="image/*" multiple>
        <div class="progress mt-2">
          <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" id="uploadProgress" style="width: 0%">0%</div>
        </div>
        <div class="mt-2" id="imagePreview" style="display: flex; flex-wrap: wrap; gap: 10px;"></div>
      </div>
    </div>

    <button type="submit" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
  </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// üîó ‡πÉ‡∏™‡πà URL Web App ‡∏Ç‡∏≠‡∏á Apps Script ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
const API_URL = 'https://script.google.com/macros/s/AKfycbzU70jZI0LU_wTmOlAx_0H7o6_SNq122_YXxCe5Mz3YylxlOx07I3BlNYLF78IGEc1m/exec';

let selectedImagesBase64 = [];

/**
 * ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ event ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
 */
document.getElementById('imageUpload').addEventListener('change', handleImageSelect);

function handleImageSelect(event) {
  const files = event.target.files;
  const preview = document.getElementById('imagePreview');
  const progressBar = document.getElementById('uploadProgress');

  preview.innerHTML = '';
  selectedImagesBase64 = [];
  progressBar.style.width = '0%';
  progressBar.textContent = '0%';

  if (!files || files.length === 0) return;

  let loadedCount = 0;
  const total = files.length;

  Array.from(files).forEach(file => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const base64 = e.target.result;
      selectedImagesBase64.push(base64);

      // ‡πÅ‡∏™‡∏î‡∏á preview
      const img = document.createElement('img');
      img.src = base64;
      img.classList.add('border', 'rounded');
      img.style.maxWidth = '120px';
      img.style.maxHeight = '120px';
      img.style.objectFit = 'cover';
      preview.appendChild(img);

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï progress bar
      loadedCount++;
      const percent = Math.round((loadedCount / total) * 100);
      progressBar.style.width = percent + '%';
      progressBar.textContent = percent + '%';
    };
    reader.readAsDataURL(file);
  });
}

/**
 * Submit form ‚Üí ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Apps Script ‡∏î‡πâ‡∏ß‡∏¢ fetch (POST)
 */
document.getElementById('equipmentForm').addEventListener('submit', async function (e) {
  e.preventDefault();

  const data = {
    commonName: document.getElementById("commonName").value.trim(),
    name: document.getElementById("name").value.trim(),
    engName: document.getElementById("engName").value.trim(),
    type: document.getElementById("type").value.trim(),
    brand: document.getElementById("brand").value.trim(),
    supplier: document.getElementById("supplier").value.trim(),
    model: document.getElementById("model").value.trim(),
    assetNo: document.getElementById("assetNo").value.trim(),
    serial: document.getElementById("serial").value.trim(),
    price: document.getElementById("price").value.trim(),
    quantity: document.getElementById("quantity").value.trim(),
    budgetYear: document.getElementById("budgetYear").value.trim(),
    receivedDate: document.getElementById("receivedDate").value.trim(),
    location: document.getElementById("location").value.trim(),
    status: document.getElementById("status").value,
    note: document.getElementById("note").value.trim()
  };

  // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏ä‡πá‡∏Å‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
  if (!data.name) {
    Swal.fire({
      icon: 'warning',
      title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å "‡∏ä‡∏∑‡πà‡∏≠" ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå',
      confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
    });
    return;
  }

  Swal.fire({
    title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...',
    allowOutsideClick: false,
    didOpen: () => Swal.showLoading()
  });

  try {
    const res = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'saveEquipment',
        data,
        images: selectedImagesBase64
      })
    });

    const result = await res.json();
    Swal.close();

    if (!res.ok || result.success === false) {
      throw new Error(result.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
    }

    Swal.fire({
      icon: 'success',
      title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
      showConfirmButton: false,
      timer: 1500
    }).then(() => {
      // ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ index (‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î)
      window.location.href = 'index.html';
    });

  } catch (err) {
    console.error(err);
    Swal.close();
    Swal.fire({
      icon: 'error',
      title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
      text: err.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ'
    });
  }
});
</script>
</body>
</html>
