<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>ระบบบริหารพัสดุห้องผ่าตัดออร์โธปิดิกส์</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
body {
  font-family: 'Tahoma', sans-serif;
  background: linear-gradient(135deg, #e8f0ff, #ffffff);
}
.header {
  background: linear-gradient(135deg, #004085, #0056b3);
  color: white;
  padding: 20px;
  display: flex;
  align-items: center;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}
.header img {
  height: 60px;
  margin-right: 15px;
}
.header h1 {
  font-size: 1.8rem;
  margin: 0;
}
.sidebar {
  background-color: #2c3e50;
  color: white;
  height: 100vh;
  padding-top: 20px;
  box-shadow: 2px 0 10px rgba(0,0,0,0.3);
}
.sidebar a {
  color: white;
  text-decoration: none;
  display: block;
  padding: 10px 20px;
  transition: background 0.3s;
}
.sidebar a:hover, .sidebar a.active {
  background-color: #1abc9c;
}
.main-content {
  padding: 20px;
  background: white;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  margin-top: 20px;
}
.footer {
  margin-top: 20px;
  background: #343a40;
  color: white;
  text-align: center;
  padding: 15px;
  font-size: 0.9rem;
  box-shadow: 0 -4px 12px rgba(0,0,0,0.2);
}
.status-label {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 20px;
  color: white;
  font-weight: bold;
  box-shadow: 0 2px 4px rgba(0,0,0,0.3);
  text-align: center;
  min-width: 70px;
  font-size: 0.9rem;
}
.status-normal {
  background: linear-gradient(135deg, #28a745, #218838);
}
.status-broken {
  background: linear-gradient(135deg, #dc3545, #c82333);
}
.status-repair {
  background: linear-gradient(135deg, #ffc107, #e0a800);
  color: black;
}
.table thead th {
  background: linear-gradient(135deg, #004085, #0062cc);
  color: white;
  text-align: center;
}
.table tbody td {
  text-align: center;
}
.btn-info {
  background: linear-gradient(135deg, #17a2b8, #138496);
  color: white;
  border: none;
  border-radius: 20px;
  padding: 6px 15px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  font-size: 0.9rem;
}
.btn-info:hover {
  background: linear-gradient(135deg, #138496, #117a8b);
  transform: scale(1.05);
}

.equipment-title {
  font-size: 1.8rem;
  font-weight: bold;
  color: #004085;
  text-align: center;
  text-shadow: 2px 2px 5px rgba(0,0,0,0.3);
  background: linear-gradient(135deg, #cce5ff, #e6f0ff);
  padding: 10px 15px;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  margin-bottom: 20px;
}
</style>
</head>
<body>

<div class="header">
  <img src="https://img5.pic.in.th/file/secure-sv1/-52b56ad2d51896660.png">
  <h1>ระบบบริหารพัสดุห้องผ่าตัดออร์โธปิดิกส์ โรงพยาบาลภูมิพลอดุลยเดช กรมแพทย์ทหารอากาศ</h1>
</div>

<div class="container-fluid">
  <div class="row">
    <div class="col-md-2 sidebar">
      <h4 class="text-center">เมนู</h4>
      <a href="index.html" class="active">แดชบอร์ดครุภัณฑ์</a>
      <!-- ไปหน้า form.html ที่อยู่บน GitHub -->
      <a href="form.html">เพิ่มครุภัณฑ์</a>
      <a href="#" onclick="showRepairForm(); return false;">บันทึกซ่อม</a>
      <a href="#">รายงาน</a>
    </div>
    <div class="col-md-10">
      <div class="main-content">
        <h3 class="equipment-title">ครุภัณฑ์ทางการแพทย์</h3>
        <div class="row mb-3">
          <div class="col-md-4">
            <input type="text" class="form-control" placeholder="ค้นหาครุภัณฑ์..." id="searchInput">
          </div>
          <div class="col-md-2">
            <button class="btn btn-success" onclick="loadEquipment()">ค้นหา</button>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-bordered table-striped">
            <thead>
              <tr>
                <th>ลำดับ</th>
                <th>Ref</th>
                <th>ชื่อทั่วไป</th>
                <th>ชื่อ</th>
                <th>รุ่น</th>
                <th>S/N</th>
                <th>สถานะ</th>
                <th>สถานที่จัดเก็บ</th>
                <th>จัดการ</th>
              </tr>
            </thead>
            <tbody id="equipmentTable">
              <tr><td colspan="9" class="text-center">กำลังโหลดข้อมูล...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal ซ่อม -->
<div class="modal fade" id="repairModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">บันทึกการซ่อมอุปกรณ์</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <label>เลือกชื่ออุปกรณ์:</label>
        <select id="repairNameSelect" class="form-select" onchange="loadRepairEquipment()">
          <option value="">-- เลือกชื่ออุปกรณ์ --</option>
        </select>
        <div id="repairPreview" style="display:none; margin-top:10px;">
          <p><strong>Ref:</strong> <span id="repairRef"></span></p>
          <p><strong>ประเภท:</strong> <span id="repairType"></span></p>
          <p><strong>ยี่ห้อ:</strong> <span id="repairBrand"></span></p>
          <div id="repairImageContainer"></div>
        </div>
        <label class="mt-2">วันที่ซ่อม (เช่น 01/07/2568):</label>
        <input type="text" id="repairDate" class="form-control">
        <label class="mt-2">รายละเอียดการซ่อม:</label>
        <textarea id="repairDetail" class="form-control"></textarea>
        <label class="mt-2">ค่าใช้จ่าย (บาท):</label>
        <input type="number" id="repairCost" class="form-control">
      </div>
      <div class="modal-footer">
        <button class="btn btn-success" onclick="saveRepair()">บันทึก</button>
      </div>
    </div>
  </div>
</div>

<div class="footer">
พัฒนาโดย พ.อ.อ.ธนกฤต วงศ์ศิลา ทำหน้าที่นายทหารสันทัดงาน กวห.รพ.ภูมิพลอดุลยเดช พอ.
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
// TODO: ใส่ URL ของ Web App จริงที่ Deploy จาก Apps Script ตรงนี้
const API_URL = 'https://script.google.com/macros/s/AKfycbzU70jZI0LU_wTmOlAx_0H7o6_SNq122_YXxCe5Mz3YylxlOx07I3BlNYLF78IGEc1m/exec';

/**
 * โหลดรายการครุภัณฑ์ทั้งหมดจาก Apps Script (Google Sheet)
 */
async function loadEquipment() {
  const searchText = document.getElementById("searchInput").value.trim().toLowerCase();
  const table = document.getElementById("equipmentTable");
  table.innerHTML = `<tr><td colspan="9" class="text-center">กำลังโหลดข้อมูล...</td></tr>`;

  try {
    const res = await fetch(`${API_URL}?action=getAllEquipment`);
    if (!res.ok) throw new Error('HTTP error ' + res.status);
    const parsedData = await res.json(); // เป็น Array ของ Object แล้ว

    table.innerHTML = "";
    if (!parsedData || parsedData.length === 0) {
      table.innerHTML = `<tr><td colspan="9" class="text-center">ไม่พบข้อมูล</td></tr>`;
      return;
    }

    let count = 1;
    parsedData.forEach(function (item) {
      const commonName = (item["ชื่อทั่วไป"] || "").toString();
      const name = (item["ชื่อ"] || "").toString();
      const model = (item["รุ่น"] || "").toString();
      const sn = (item["S/N"] || "").toString();
      const location = (item["สถานที่จัดเก็บ"] || "").toString();

      if (
        searchText === "" ||
        commonName.toLowerCase().includes(searchText) ||
        name.toLowerCase().includes(searchText) ||
        model.toLowerCase().includes(searchText) ||
        sn.toLowerCase().includes(searchText) ||
        location.toLowerCase().includes(searchText)
      ) {
        const row = `
          <tr>
            <td>${count++}</td>
            <td>${item["Ref"] || ""}</td>
            <td>${commonName}</td>
            <td>${name}</td>
            <td>${model}</td>
            <td>${sn}</td>
            <td>${getStatusBadge(item["สถานะ"])}</td>
            <td>${location}</td>
            <td><button class="btn btn-sm btn-info" onclick="viewDetail('${item["Ref"]}')">ดูรายละเอียด</button></td>
          </tr>`;
        table.insertAdjacentHTML("beforeend", row);
      }
    });

    if (count === 1) {
      table.innerHTML = `<tr><td colspan="9" class="text-center">ไม่พบข้อมูลที่ตรงกับการค้นหา</td></tr>`;
    }

  } catch (err) {
    console.error(err);
    table.innerHTML = `<tr><td colspan="9" class="text-center text-danger">ไม่สามารถโหลดข้อมูลได้</td></tr>`;
    Swal.fire({
      icon: 'error',
      title: 'โหลดข้อมูลไม่สำเร็จ',
      text: err.message || 'เกิดข้อผิดพลาดในการเชื่อมต่อเซิร์ฟเวอร์'
    });
  }
}

/**
 * เปิดหน้า viewDetail.html บน GitHub พร้อมส่ง ref ไปเป็น query string
 */
function viewDetail(ref) {
  // สร้าง viewDetail.html ไว้ใน repo แล้วใช้ ref นี้ไปเรียก API อีกทีในหน้านั้น
  window.location.href = `viewDetail.html?ref=${encodeURIComponent(ref)}`;
}

/**
 * แสดง Modal เลือกอุปกรณ์สำหรับบันทึกซ่อม
 */
async function showRepairForm() {
  const select = document.getElementById("repairNameSelect");
  select.innerHTML = `<option value="">กำลังโหลด...</option>`;

  try {
    const res = await fetch(`${API_URL}?action=getAllEquipment`);
    if (!res.ok) throw new Error('HTTP error ' + res.status);
    const data = await res.json();

    select.innerHTML = `<option value="">-- เลือกชื่ออุปกรณ์ --</option>`;
    data.forEach(item => {
      const option = document.createElement("option");
      option.value = item["Ref"];
      option.text = item["ชื่อ"] || item["ชื่อทั่วไป"] || item["Ref"];
      select.appendChild(option);
    });

    new bootstrap.Modal(document.getElementById("repairModal")).show();
  } catch (err) {
    console.error(err);
    Swal.fire({
      icon: 'error',
      title: 'ไม่สามารถโหลดรายการอุปกรณ์',
      text: err.message || 'กรุณาลองใหม่อีกครั้ง'
    });
  }
}

/**
 * โหลดข้อมูลอุปกรณ์ตาม Ref มาแสดงใน preview ของ modal ซ่อม
 */
async function loadRepairEquipment() {
  const ref = document.getElementById("repairNameSelect").value;
  const preview = document.getElementById("repairPreview");

  if (!ref) {
    preview.style.display = "none";
    return;
  }

  try {
    const res = await fetch(`${API_URL}?action=getEquipmentByRef&ref=${encodeURIComponent(ref)}`);
    if (!res.ok) throw new Error('HTTP error ' + res.status);
    const item = await res.json();
    if (!item) {
      preview.style.display = "none";
      return;
    }

    document.getElementById("repairRef").innerText = item["Ref"] || "";
    document.getElementById("repairType").innerText = item["ประเภท"] || "";
    document.getElementById("repairBrand").innerText = item["ยี่ห้อ"] || "";

    const imgContainer = document.getElementById("repairImageContainer");
    if (item["รูปภาพ"]) {
      imgContainer.innerHTML = `<img src="${item["รูปภาพ"]}" style="max-width:100%; max-height:200px;">`;
    } else {
      imgContainer.innerHTML = "<p>ไม่มีรูปภาพ</p>";
    }

    preview.style.display = "block";

  } catch (err) {
    console.error(err);
    Swal.fire({
      icon: 'error',
      title: 'โหลดข้อมูลอุปกรณ์ไม่สำเร็จ',
      text: err.message || 'กรุณาลองใหม่อีกครั้ง'
    });
  }
}

/**
 * บันทึกข้อมูลการซ่อม ผ่าน API (POST → saveRepairData)
 */
async function saveRepair() {
  const ref = document.getElementById("repairRef").innerText;
  const repairDate = document.getElementById("repairDate").value;
  const repairDetail = document.getElementById("repairDetail").value;
  const repairCost = document.getElementById("repairCost").value;

  if (!ref || !repairDate || !repairDetail) {
    Swal.fire({
      icon: 'warning',
      title: 'กรุณากรอกข้อมูลให้ครบถ้วน',
      confirmButtonText: 'ตกลง'
    });
    return;
  }

  const repairData = { ref, repairDate, repairDetail, repairCost };

  Swal.fire({
    title: 'กำลังบันทึก...',
    allowOutsideClick: false,
    didOpen: () => Swal.showLoading()
  });

  try {
    const res = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'saveRepairData',
        data: repairData
      })
    });

    const result = await res.json();
    Swal.close();

    if (!res.ok || result.success === false) {
      throw new Error(result.error || 'บันทึกข้อมูลไม่สำเร็จ');
    }

    Swal.fire({
      icon: 'success',
      title: 'สำเร็จ',
      text: result.message || 'บันทึกข้อมูลการซ่อมเรียบร้อย',
      confirmButtonText: 'ตกลง'
    }).then(() => {
      const repairModal = bootstrap.Modal.getInstance(document.getElementById("repairModal"));
      if (repairModal) repairModal.hide();
      loadEquipment(); // refresh ตาราง
    });

  } catch (err) {
    console.error(err);
    Swal.close();
    Swal.fire({
      icon: 'error',
      title: 'เกิดข้อผิดพลาด',
      text: err.message || 'ไม่สามารถบันทึกข้อมูลได้'
    });
  }
}

/**
 * แสดง Badge สถานะ
 */
function getStatusBadge(statusText) {
  if (statusText === "ปกติ") return `<span class="status-label status-normal">ปกติ</span>`;
  if (statusText === "ชำรุด") return `<span class="status-label status-broken">ชำรุด</span>`;
  if (statusText === "ส่งซ่อม") return `<span class="status-label status-repair">ส่งซ่อม</span>`;
  return `<span class="status-label">${statusText || "-"}</span>`;
}

window.onload = loadEquipment;
</script>
</body>
</html>
